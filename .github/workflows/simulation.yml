name: Simulation Workflow optimized
on:
  workflow_dispatch:
    inputs:
      lambda_value:
        description: "Lambda value for MEWMA"
        default: "0.1"
        required: true

jobs:
  simulate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # اگر یک شارد شکست خورد، بقیه ادامه دهند
      matrix:
        shard: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip' # ⚡ فعال‌سازی کش برای افزایش سرعت نصب

      - name: Install Requirements
        run: |
          pip install numpy pandas numba

      - name: Run Simulation Shard
        run: |
          # تعریف متغیرها برای خوانایی
          N_TOTAL=100000
          SHARDS=20
          N_SIM=$((N_TOTAL / SHARDS))
          # فرمول سید: Seed پایه + شماره شارد (مطمئن می‌شویم همپوشانی ندارند)
          BASE_SEED=$((10000 + ${{matrix.shard}} * 100000))
          
          mkdir -p results_shard

          python simulation_engine.py \
            --lambda_value ${{ github.event.inputs.lambda_value }} \
            --n_sim $N_SIM \
            --base_seed $BASE_SEED \
            --out results_shard

      - name: Upload Shard
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{matrix.shard}}
          path: results_shard
          retention-days: 1 # کاهش زمان نگهداری برای صرفه‌جویی

  merge:
    runs-on: ubuntu-latest
    needs: simulate
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - run: pip install pandas

      - name: Download Shards
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: all_shards
          merge-multiple: true

      - name: Merge Results
        run: |
          # استفاده از اسکریپت ساده پایتون برای ادغام (In-line برای سادگی)
          python -c "
          import pandas as pd
          import glob
          import sys
          
          files = glob.glob('all_shards/*.csv')
          if not files:
              print('❌ No CSV files found!')
              sys.exit(1)
              
          print(f'Found {len(files)} files. Merging...')
          df_list = [pd.read_csv(f) for f in files]
          final_df = pd.concat(df_list, ignore_index=True)
          
          # محاسبه میانگین نهایی از روی تمام شاردها
          summary = final_df.groupby(['Lambda', 'Scenario'])['ARL'].mean().reset_index()
          summary.to_csv('final_report_summary.csv', index=False)
          final_df.to_csv('final_report_full.csv', index=False)
          print('✅ Merge complete.')
          "

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final_report_${{ github.run_id }}
          path: |
            final_report_summary.csv
            final_report_full.csv
